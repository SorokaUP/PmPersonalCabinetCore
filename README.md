# Личный кабинет для запроса информации о статусах КИЗ в системе МДЛП (ядро)

Работает в связке с проектом [PmPersonalCabinet](https://github.com/SorokaUP/PmPersonalCabinet)

---

Проект обрабатывает запросы к **RestApi МДЛП** (*система Честный знак, реализован метод запроса статусов КИЗ*), полученные данные в формате *JSON* передает внешним програмным решениям. 

Отправка данных осуществляется посредством подписи отправляемого запроса с помощью **УКЭП** через собственную библиотеку Windows на C# (*CryptApi.dll*), 
которая по отпечатку публичного ключа получает из локального хранилища сертификат и производит подпись отправляемого сообщения.
Хранение данных пользователя (*идентификаторы учетной системы, идентификаторы пользователей, данные отпечатка публичного сертификата и прочая системная информация о сессии*) хранятся в базе данных **PostgreSQL**, подключение и работа с которой описана в соответствующих файлах **/core.py** и **dao.py** директории **db/posgresql**.

Выбор пользователя и данных сертификата осуществляется через файл конфигурации **config.py**, где достаточно указать **user_id** (*UUID пользователя в системе МДЛП*), и объявить структуру **user_info** (*экземпляр класса model.UserInfo*).

Список методов и интервалы вызовов описаны в соответсвующих файлах **method.py** и **timeout.py**.

Информация о заголовках **HTTPS** и **URL** описаны в файле **core.py**. 

Метод аутентификации в системе **МДЛП** описан в файле **auth.py**.

(!) В ПРОЕКТЕ ОТСУТСТВУЕТ БАЗА ДАННЫХ И САМ СЕРТИФИКАТ УКЭП, ТАК КАК ЭТО КОНФИДЕНЦИАЛЬНАЯ ИНФОРМАЦИЯ, ВЫПОЛНИТЬ ПРОГРАММУ БЕЗ НИХ НЕВОЗМОЖНО. 

---

## Пример вызова

    data = api_search_kiz(["046071598604081W3ER00000000", "046071598604081W3ERPCKD3T0C", "0460715986040828SVYAM5YX3NY", "046400186411386528734054135", "046400186411383914344477297", "0475023200591002062UMF5L03R", "0475023200591002062UMG5NS2F", "042503695090651121352426121", "042503695090651121352436169", "0475023200591002060ANP4C2CC", "0475023200591002060ANR83ZTP", '059447282610915485', '589017830000023675', '146501092334774466', '146501092383403058'])
    print(data)
    
    
## Пример ответа

    Авторизуюсь (53e4e9ac-4eeb-4bd5-98d4-eadce4a348c9): Код... Токен... Успешно.
    {'entries': [{'kiz': '046400186411383914344477297', 'parent': '', 'name': 'Рофлокс-Скан (ЛЕВОФЛОКСАЦИН)', 'status': 'in_circulation', 'mod': '00000000163257', 'batch': '0010121', 'expiration_date': '2023-02-28', 'sgtin_prod_d_name': '500 мг', 'sgtin_prod_form_name': 'ТАБЛЕТКИ, ПОКРЫТЫЕ ОБОЛОЧКОЙ', 'sgtin_reg_holder': 'СКАН БИОТЕК ЛТД.', 'sgtin_drug_code': '21.20.10.191-000004-1-00279-2000001047982', 'status_rus': 'В обороте (in_circulation)', 'mod_address': '', 'mod_guid': '', 'mod_color': '', 'owner': '', 'owner_inn': '', 'owner_sys_id': ''}, {'kiz': '046400186411386528734054135', 'parent': '', 'name': 'Рофлокс-Скан (ЛЕВОФЛОКСАЦИН)', 'status': 'in_circulation', 'mod': '00000000163257', 'batch': '0010121', 'expiration_date': '2023-02-28', 'sgtin_prod_d_name': '500 мг', 'sgtin_prod_form_name': 'ТАБЛЕТКИ, ПОКРЫТЫЕ ОБОЛОЧКОЙ', 'sgtin_reg_holder': 'СКАН БИОТЕК ЛТД.', 'sgtin_drug_code': '21.20.10.191-000004-1-00279-2000001047982', 'status_rus': 'В обороте (in_circulation)', 'mod_address': '', 'mod_guid': '', 'mod_color': '', 'owner': '', 'owner_inn': '', 'owner_sys_id': ''}, {'kiz': '0475023200591002062UMG5NS2F', 'parent': '', 'name': 'Милдронат (МЕЛЬДОНИЙ)', 'status': 'in_sale', 'mod': '00000000454610', 'batch': '041121', 'expiration_date': '2025-11-30', 'sgtin_prod_d_name': '250 мг', 'sgtin_prod_form_name': 'КАПСУЛЫ', 'sgtin_reg_holder': 'AO ГРИНДЕКС', 'sgtin_drug_code': '21.20.10.141-000007-1-00160-2000001125771', 'status_rus': 'Продан в розницу (in_sale)', 'mod_address': '', 'mod_guid': '', 'mod_color': '', 'owner': '', 'owner_inn': '', 'owner_sys_id': ''}, {'kiz': '0475023200591002060ANR83ZTP', 'parent': '', 'name': 'Милдронат (МЕЛЬДОНИЙ)', 'status': 'in_partial_sale', 'mod': '00000000379770', 'batch': '8401121', 'expiration_date': '2025-11-30', 'sgtin_prod_d_name': '250 мг', 'sgtin_prod_form_name': 'КАПСУЛЫ', 'sgtin_reg_holder': 'AO ГРИНДЕКС', 'sgtin_drug_code': '21.20.10.141-000007-1-00160-2000001125771', 'status_rus': 'Частично продан в розницу (in_partial_sale)', 'mod_address': '', 'mod_guid': '', 'mod_color': '', 'owner': '', 'owner_inn': '', 'owner_sys_id': ''}, {'kiz': '0475023200591002062UMF5L03R', 'parent': '', 'name': 'Милдронат (МЕЛЬДОНИЙ)', 'status': 'in_sale', 'mod': '00000000174877', 'batch': '041121', 'expiration_date': '2025-11-30', 'sgtin_prod_d_name': '250 мг', 'sgtin_prod_form_name': 'КАПСУЛЫ', 'sgtin_reg_holder': 'AO ГРИНДЕКС', 'sgtin_drug_code': '21.20.10.141-000007-1-00160-2000001125771', 'status_rus': 'Продан в розницу (in_sale)', 'mod_address': '', 'mod_guid': '', 'mod_color': '', 'owner': '', 'owner_inn': '', 'owner_sys_id': ''}, {'kiz': '042503695090651121352436169', 'parent': '', 'name': 'Релиф Адванс (БЕНЗОКАИН)', 'status': 'in_sale', 'mod': '00000000178167', 'batch': '21K08', 'expiration_date': '2023-11-22', 'sgtin_prod_d_name': '206 мг', 'sgtin_prod_form_name': 'СУППОЗИТОРИИ РЕКТАЛЬНЫЕ', 'sgtin_reg_holder': 'АО БАЙЕР', 'sgtin_drug_code': '21.20.10.154-000002-1-00006-2000000991347', 'status_rus': 'Продан в розницу (in_sale)', 'mod_address': '184060, Мурманская область, Кандалакшский район, с. Алакуртти, улица Грязнова, д. 2. Аптека ?Арника?', 'mod_guid': 'bce19463-ab30-4118-8280-7448a34202f2', 'mod_color': '', 'owner': 'ИП КАМЕНЕВА Е.В.', 'owner_inn': '510200612385', 'owner_sys_id': '4bb6ce2f-0eed-4f1b-aad4-9f940f3f206c'}, {'kiz': '146501092334774466', 'parent': 'None', 'status': 'in_circulation', 'mod': '00000000146887', 'error_code': '', 'error_desc': '', 'sscc_count': '32', 'sscc_last_date': '2022-09-04T21:33:43', 'sscc_status_date': '2022-06-29T07:36:36', 'status_rus': 'В обороте (in_circulation)', 'mod_address': '127521, г. Москва, пр. Марьиной Рощи 17-й, д. 13, стр. 5', 'mod_guid': 'b99e6a5e-8505-4c41-8e86-edb2b2dc35d7', 'mod_color': '#d1e7dd', 'owner': 'ЗАКРЫТОЕ АО "ПРОФИТМЕД"', 'owner_inn': '7719022542', 'owner_sys_id': 'e53bc6e8-eca5-49e5-b5dd-1ff78f81bdd5'}, {'kiz': '059447282610915485', 'parent': 'None', 'status': 'in_circulation', 'mod': '00000000146887', 'error_code': '', 'error_desc': '', 'sscc_count': '1', 'sscc_last_date': '2022-10-12T22:27:52', 'sscc_status_date': '2022-06-17T07:01:15', 'status_rus': 'В обороте (in_circulation)', 'mod_address': '127521, г. Москва, пр. Марьиной Рощи 17-й, д. 13, стр. 5', 'mod_guid': 'b99e6a5e-8505-4c41-8e86-edb2b2dc35d7', 'mod_color': '#d1e7dd', 'owner': 'ЗАКРЫТОЕ АО "ПРОФИТМЕД"', 'owner_inn': '7719022542', 'owner_sys_id': 'e53bc6e8-eca5-49e5-b5dd-1ff78f81bdd5'}], 'failed_entries': [{'kiz': '046071598604081W3ER00000000', 'error_code': '2', 'error_desc': 'Запрашиваемые данные не найдены'}, {'kiz': '046071598604081W3ERPCKD3T0C', 'error_code': '2', 'error_desc': 'Запрашиваемые данные не найдены'}, {'kiz': '0475023200591002060ANP4C2CC', 'error_code': '2', 'error_desc': 'Запрашиваемые данные не найдены'}, {'kiz': '0460715986040828SVYAM5YX3NY', 'error_code': '2', 'error_desc': 'Запрашиваемые данные не найдены'}, {'kiz': '042503695090651121352426121', 'error_code': '2', 'error_desc': 'Запрашиваемые данные не найдены'}, {'kiz': '589017830000023675', 'error_code': '2', 'error_desc': 'Запрашиваемые данные не найдены'}, {'kiz': '146501092383403058', 'error_code': '2', 'error_desc': 'Запрашиваемые данные не найдены'}]}


---

В проекте использованы:
* Получение информации из базы данных **PostgreSQL**;
* Внешняя библиотека Windows собственной разработки для работы с **УКЭП** (*CryptApi.dll*) из локального хранилища Windows.
